{% extends 'layout/base.html' %}

{% block content %}

<div class="row" class="container-panel" style="padding-bottom: 40px">
    <h4> عرض الطلب </h4>

    <hr>
    <label class="panel-title">البيانات الشخصية للمتقدم</label>
    <div class="panel-form-wide">
        <div class="row" style="width: 100%">
            <div class="col-md-6 col-sm-12">
                <label>رقم الهوية:</label>
                <p>{{ application.applicant.id_number }}</p>
            </div>
            <div class="col-md-6 col-sm-12">
                <label>الاسم بالكامل:</label>
                <p>{{ application.applicant.fullname }}</p>
            </div>
        </div>

        <div class="row" style="width: 100%">
            <div class="col-md-6 col-sm-12">
                <label>البريد الالكتروني:</label>
                <p>{{ application.applicant.email }}</p>
            </div>
            <div class="col-md-6 col-sm-12">
                <label>رقم الجوال:</label>
                <p>{{ application.applicant.mobile }} ({{ application.applicant.phonecode }})</p>
            </div>
        </div>

        <div class="row" style="width: 100%">
            <div class="col-md-6 col-sm-12">
                <label>تاريخ الميلاد:</label>
                <p>{{ application.applicant.birthdate|date }} ({{ application.applicant.birthdatehijri_dateformat|date }})</p>
            </div>
            <div class="col-md-6 col-sm-12">
                <label>الجنس:</label>
                <p>{{ application.applicant.gender_text }}</p>
            </div>
        </div>

        <div class="row" style="width: 100%">
            <div class="col-md-6 col-sm-12">
                <label>كود الدولة:</label>
                <p>{{ application.applicant.countryid }}</p>
            </div>
        </div>
    </div>

    <hr>
    <label class="panel-title">تفاصيل الطلب</label>
    <div class="panel-form-wide">
        <div class="row" style="width: 100%">
            <div class="col-md-6 col-sm-12">
                <label>نوع الطلب:</label>
                <p>{{ application.applicant.type_text }}</p>
            </div>
            <div class="col-md-6 col-sm-12">
                <label>حالة الطلب:</label>
                <p>{{ application.status.name }}</p>
            </div>
        </div>

        <div class="row" style="width: 100%">
            <div class="col-md-6 col-sm-12">
                <label>الخدمة المطلوبة:</label>
                <p>{{ application.service.name }}</p>
            </div>
            <div class="col-md-6 col-sm-12">
                <label>رمز الطلب:</label>
                <p>{{ application.serial }}</p>
            </div>
        </div>

        <div class="row" style="width: 100%">
            <div class="col-sm-12">
                <label>المستندات المقدمة:</label>
            </div>
        </div>

        <div class="row" style="width: 100%">
            <div class="col-sm-12">
                {% for doc in application.documents.all %}
                    {% if doc.file_type == ApplicationDocument.TYPES.IMAGE %}
                        <div class="col-sm-2 application-document-icon application-document-icon-img" style="background-image: url('{{ doc.file.url }}')" data-toggle="tooltip" data-title="عرض الملف" onclick="displayViewer('image', '{{ doc.file.url }}', '{{ doc.description }}')"><span class="file-preview-description">{{ doc.description }}</span></div>
                    {% elif doc.file_type == ApplicationDocument.TYPES.PDF %}
                        <div class="col-sm-2 application-document-icon application-document-icon-pdf" data-toggle="tooltip" data-title="عرض الملف" onclick="displayViewer('pdf', '{{ doc.file.url }}', '{{ doc.description }}')"><i class="fa fa-file-pdf-o"></i><span class="file-preview-description">{{ doc.description }}</span></div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>


        <div class="row" style="width: 100%; margin-top: 20px;">
            <div class="col-sm-12">
        <hr>
                <label>العمليات السابقة:</label>
            </div>
        </div>

        <div class="row" style="width: 100%;">
            <div class="col-sm-12">
                <table class="table">
                    <thead>
                        <tr>
                            <th>المستخدم</th>
                            <th>الإجراء</th>
                            <th>التاريخ</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if application.action_history %}
                            {% for entry in application.action_history %}
                                <tr>
                                    {% if entry.invoker %}
                                        <td class="history-name-field">{{ entry.invoker.first_name|add:' '|add:entry.invoker.last_name }}</td>
                                    {% else %}
                                        <td class="history-name-field"><i style="color: green">المتقدم بالطلب</i></td>
                                    {% endif %}
                                    <td class="history-operation-field">{{ entry.text }}</td>
                                    <td class="history-date-field">{{ entry.created_at|date }}</td>
                                </tr>
                            {% endfor %}
                        {% else %}
                                <tr><td style="text-align: left;" colspan="3"><h4 style="text-align: center;"><i>لا يوجد</i></h4></td></tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

{% if user_role == 'officer' and application.status.value <= ApplicationStatus.IN_REVISION or user_role == 'officer' and application.status.value == ApplicationStatus.RETURNED_REVISION or user_role == 'manager' and application.status.value == ApplicationStatus.IN_MANAGER or user_role == 'president' and application.status.value == ApplicationStatus.IN_PRESIDENT %}
    <div class="action-panel">
        <form action="{% url 'moderation:action_application' application.id %}" method="POST" style="width: 100%">
            {% csrf_token %}
            <div class="action-message action-message-reject" style="display: none;">
                <p>
                    <strong>من فضلك أدخل السبب</strong><br>

                    {% if user_role == 'officer' %}
                        <small>سيتم إرجاع الطلب للمتقدم به مع ذكر السبب</small>
                    {% else %}
                        <small>سيتم إرجاع الطلب لمسؤول التراخيص للمراجعة مع ذكر السبب</small>
                    {% endif %}
                </p>
                <textarea class="form-control" name="reason" rows="5" data-rule-required="true" data-msg-required="أدخل سبب الرفض"></textarea>

                <small>(اضغط موافقة مرة أخرى للتأكيد)</small>
            </div>

            <div class="action-message action-message-approve" style="display: none;">
                <p>
                    <strong>هل أنت متأكد؟</strong><br>

                    {% if user_role == 'officer' %}
                        سيتم إرسال الطلب إلى مدير الأكاديمية للمراجعة <br>
                    {% elif user_role == 'manager' %}
                        سيتم إرسال الطلب إلى رئيس الأكاديمية للمراجعة <br>
                    {% endif %}

                    <small>(اضغط موافقة مرة أخرى للتأكيد)</small>
                </p>
            </div>

            <div class="action-bottom-content">
                <span class="action-panel-title">اتخذ إجراء</span>
                <span class="actions-wrapper">
                    <input type="hidden" name="_action">
                    <button type="button" class="btn btn-success action-approve-btn" data-action=""> <i class="fa fa-check"></i> موافقة</button>
                    <button type="button" class="btn btn-danger action-reject-btn"> <i class="fa fa-times"></i> <span>رفض</span></button>
                </span>
            </div>
        </form>
    </div>
{% endif %}


    <div class="file-viewer image-viewer-wrapper" style="display: none;">
        <div class="viewer-top-bar">
            <span class="viewer-file-description"></span>
            <span class="viewer-option-button viewer-applicant-info-btn" data-toggle="tooltip" data-title="عرض/إخفاء بيانات المتقدم" data-placement="bottom"><i class="fa fa-eye"></i></span>
            <span class="viewer-option-button viewer-close-btn" data-toggle="tooltip" data-title="غلق" data-placement="bottom"><i class="fa fa-times"></i></span>
        </div>
        <div class="viewer-file-content">
            <img class="inner-image" src="">
        </div>

        <div class="file-viewer-info-panel" style="display: none;">
            <div class="info-item">
                <label>رقم الهوية:</label>
                <p>{{ application.applicant.id_number }}</p>
            </div>
            <div class="info-item">
                <label>الاسم بالكامل:</label>
                <p>{{ application.applicant.fullname }}</p>
            </div>

            <div class="info-item">
                <label>البريد الالكتروني:</label>
                <p>{{ application.applicant.email }}</p>
            </div>
            <div class="info-item">
                <label>رقم الجوال:</label>
                <p>{{ application.applicant.mobile }} ({{ application.applicant.phonecode }})</p>
            </div>

            <div class="info-item">
                <label>تاريخ الميلاد:</label>
                <p>{{ application.applicant.birthdate|date }} ({{ application.applicant.birthdatehijri_dateformat|date }})</p>
            </div>
            <div class="info-item">
                <label>الجنس:</label>
                <p>{{ application.applicant.gender_text }}</p>
            </div>

            <div class="info-item">
                <label>كود الدولة:</label>
                <p>{{ application.applicant.countryid }}</p>
            </div>
        </div>
    </div>

    <div class="file-viewer pdf-viewer-wrapper" style="display: none;">
        <div class="viewer-top-bar">
            <span class="viewer-file-description"></span>
            <span class="viewer-option-button viewer-applicant-info-btn" data-toggle="tooltip" data-title="عرض/إخفاء بيانات المتقدم" data-placement="bottom"><i class="fa fa-eye"></i></span>
            <span class="viewer-option-button viewer-close-btn" data-toggle="tooltip" data-title="غلق" data-placement="bottom"><i class="fa fa-times"></i></span>
        </div>
        <div class="viewer-file-content">
            <object data="" type="application/pdf">
                <embed src="" type="application/pdf">
            </object>
        </div>

        <div class="file-viewer-info-panel" style="display: none;">
            <div class="info-item">
                <label>رقم الهوية:</label>
                <p>{{ application.applicant.id_number }}</p>
            </div>
            <div class="info-item">
                <label>الاسم بالكامل:</label>
                <p>{{ application.applicant.fullname }}</p>
            </div>

            <div class="info-item">
                <label>البريد الالكتروني:</label>
                <p>{{ application.applicant.email }}</p>
            </div>
            <div class="info-item">
                <label>رقم الجوال:</label>
                <p>{{ application.applicant.mobile }} ({{ application.applicant.phonecode }})</p>
            </div>

            <div class="info-item">
                <label>تاريخ الميلاد:</label>
                <p>{{ application.applicant.birthdate|date }} ({{ application.applicant.birthdatehijri_dateformat|date }})</p>
            </div>
            <div class="info-item">
                <label>الجنس:</label>
                <p>{{ application.applicant.gender_text }}</p>
            </div>

            <div class="info-item">
                <label>كود الدولة:</label>
                <p>{{ application.applicant.countryid }}</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
    <script>
        $(document).ready(function(){
            $('form').validate();
        });

        var imageViewer = $('.image-viewer-wrapper');
        var pdfViewer = $('.pdf-viewer-wrapper');

        $('.file-viewer .viewer-close-btn').click(hideViewer);
        $('.file-viewer .viewer-file-content').click(hideViewer);

        $('.file-viewer .viewer-applicant-info-btn').click(toggleViewerInfo);

        function displayViewer(type, src, description) {
            if (type === 'image') {
                imageViewer.find('.viewer-file-description').html(description);
                imageViewer.find('.viewer-file-content .inner-image').attr('src', src);
                $('body')[0].style['overflow'] = 'hidden';
                imageViewer.fadeIn('fast');
            }
            else if (type === 'pdf') {
                pdfViewer.find('.viewer-file-description').html(description);
                pdfViewer.find('.viewer-file-content object').attr('data', src);
                pdfViewer.find('.viewer-file-content embed').attr('src', src);
                $('body')[0].style['overflow'] = 'hidden';
                pdfViewer.fadeIn('fast');
            }
        }

        function hideViewer(){
            $('.file-viewer').fadeOut('fast');
            $('body')[0].style['overflow'] = '';
            hideViewerInfo();
            $('.viewer-file-content')[0].scrollTo(0, 0);
        }

        function showViewerInfo(){
            $('.file-viewer .file-viewer-info-panel').slideDown('fast');
        }

        function hideViewerInfo(){
            $('.file-viewer .file-viewer-info-panel').slideUp('fast');
        }

        function toggleViewerInfo() {
            var visible = $('.file-viewer .file-viewer-info-panel')[0].style['display'] !== 'none';

            if (visible) {
                hideViewerInfo();
            }
            else {
                showViewerInfo();
            }
        }

        function focusActionBar() {
            $('html, body').animate({
                scrollTop: actionPanel.offset().top
            }, 200);
        }

        function showApprovePanel() {
            hideRejectPanel();
            $('.action-message-approve').slideDown('fast', function(){actionAgree.attr('type', 'submit');});
            focusActionBar();
            actionAgree.attr('data-action', 'approve');
            _action.val('approve');
            $('button.action-reject-btn > span').html('إلغاء');
        }

        function hideApprovePanel() {
            $('.action-message-approve').slideUp('fast');
            {#focusActionBar();#}
            actionAgree.attr('data-action', '');
            _action.val('');
            actionAgree.attr('type', 'button');
            $('button.action-reject-btn > span').html('رفض');
        }

        function showRejectPanel() {
            hideApprovePanel();
            $('.action-message-reject').slideDown('fast', function(){actionAgree.attr('type', 'submit');});
            focusActionBar();
            actionAgree.attr('data-action', 'reject');
            _action.val('reject');
            $('button.action-reject-btn > span').html('إلغاء');
        }

        function hideRejectPanel() {
            $('.action-message-reject').slideUp('fast');
            {#focusActionBar();#}
            actionAgree.attr('data-action', '');
            _action.val('');
            actionAgree.attr('type', 'button');
            $('button.action-reject-btn > span').html('رفض');
        }

        var firstAction = false;

        var actionPanel = $('.action-panel');
        var actionAgree = $('.action-approve-btn');
        var actionReject = $('.action-reject-btn');
        var _action = $('input[name=_action]');

        actionAgree.click(function(){
            if (!firstAction){
                showApprovePanel();
                firstAction = true;
            }
            else {
                //submit approval or rejection
            }
        });

        actionReject.click(function(){
            if (firstAction){
                hideApprovePanel();
                hideRejectPanel();
                firstAction = false;
            }
            else {
                showRejectPanel();
                firstAction = true;
            }
        });
    </script>
{% endblock %}
